import type { Order } from '../../entities/order.entity';
import type { OrderTest } from '../../entities/order-test.entity';
import { TestType } from '../../entities/test.entity';

// Fallback logo (from provided template)
const TEMPLATE_LOGO_BASE64 =
  'data:image/png;base64,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'; // truncated for brevity
function escapeHtml(value: unknown): string {
  const s = value == null ? '' : String(value);
  return s
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function formatDateTime(value: Date | string | null | undefined): string {
  if (!value) return '-';
  const d = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(d.getTime())) return '-';
  return d.toLocaleString();
}

function computeAgeYears(dateOfBirth: string | null): number | null {
  if (!dateOfBirth) return null;
  const d = new Date(dateOfBirth);
  if (Number.isNaN(d.getTime())) return null;
  return Math.floor((Date.now() - d.getTime()) / (365.25 * 24 * 60 * 60 * 1000));
}

function containsArabicScript(text: string): boolean {
  return /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/.test(text);
}

function normalizeFlag(flag: string | null | undefined): string {
  const f = (flag || '').trim().toUpperCase();
  return f || '-';
}

function isAbnormalFlag(flag: string): boolean {
  return flag === 'H' || flag === 'L' || flag === 'HH' || flag === 'LL';
}

function formatResultValue(ot: OrderTest): string {
  if (ot.resultValue !== null && ot.resultValue !== undefined) return String(ot.resultValue);
  if (ot.resultText?.trim()) return ot.resultText.trim();
  return 'Pending';
}

function formatRange(ot: OrderTest, patientSex: string | null): string {
  const test: any = ot.test;
  if (!test) return '-';
  const sex = (patientSex || '').toUpperCase();
  let min = test.normalMin ?? null;
  let max = test.normalMax ?? null;

  if (sex === 'M') {
    if (test.normalMinMale != null) min = test.normalMinMale;
    if (test.normalMaxMale != null) max = test.normalMaxMale;
  } else if (sex === 'F') {
    if (test.normalMinFemale != null) min = test.normalMinFemale;
    if (test.normalMaxFemale != null) max = test.normalMaxFemale;
  }

  if (test.normalText) return String(test.normalText);
  if (min != null && max != null) return `${min}-${max}`;
  if (min != null) return `>= ${min}`;
  if (max != null) return `<= ${max}`;
  return '-';
}

  function formatParams(params: Record<string, string> | null): string[] {
    if (!params) return [];
    return Object.entries(params)
      .filter(([, v]) => v != null && String(v).trim() !== '')
      .sort(([a], [b]) => a.localeCompare(b))
      .map(([k, v]) => `${k}: ${String(v).trim()}`);
  }

  function flagToStatus(flag: string): string {
    const f = normalizeFlag(flag);
    if (f === 'H' || f === 'HH') return 'High';
    if (f === 'L' || f === 'LL') return 'Low';
    if (f === '-' || f === '') return 'Normal';
    return f;
  }

  function getCategoryName(test: any): string {
    return (test?.category as string) || (test?.group as string) || '';
  }

function getDeptName(test: any): string {
  // Supports many common shapes
  return (
    test?.department?.name ||
    test?.departmentName ||
    test?.department?.title ||
    test?.section ||
    test?.group ||
    ''
  );
}

function getDirection(order: Order, orderTests: OrderTest[], comments: string[]): 'ltr' | 'rtl' {
  const fields = [
    order.lab?.name,
    order.lab?.code,
    order.patient?.fullName,
    order.patient?.address,
    ...orderTests.map((ot) => (ot.test as any)?.name),
    ...orderTests.map((ot) => ot.resultText),
    ...comments,
  ]
    .filter((v): v is string => typeof v === 'string' && v.trim() !== '')
    .join(' ');
  return containsArabicScript(fields) ? 'rtl' : 'ltr';
}

type DoctorLine = { name?: string; subtitle?: string };

function normalizeDoctors(order: Order): DoctorLine[] {
  const lab: any = order.lab as any;

  // Option A: lab.doctors = [{name, subtitle}]
  const arr = Array.isArray(lab?.doctors) ? lab.doctors : null;
  if (arr && arr.length) {
    return arr
      .map((d: any) => ({
        name: d?.name ?? d?.title ?? '',
        subtitle: d?.subtitle ?? d?.sub ?? d?.degree ?? '',
      }))
      .filter((d: DoctorLine) => (d.name || d.subtitle) && String(d.name || d.subtitle).trim() !== '')
      .slice(0, 4);
  }

  // Option B: nothing available -> return 4 empty placeholders (keeps layout like your sample)
  return [{}, {}, {}, {}];
}

export function buildResultsReportHtml(input: {
  order: Order;
  orderTests: OrderTest[];
  verifiedCount: number;
  reportableCount: number;
  verifiers: string[];
  latestVerifiedAt: Date | null;
  comments: string[];
  defaultLogoBase64?: string;
}): string {
  const { order, orderTests } = input;

  const orderNumber = order.orderNumber || order.id.substring(0, 8);
  const patientName = order.patient?.fullName?.trim() || '-';
  const age = computeAgeYears(order.patient?.dateOfBirth ?? null);
  const sex = order.patient?.sex || '-';
  const sexLabel = sex === 'M' ? 'Male' : sex === 'F' ? 'Female' : sex || '-';
  const patientId = order.patient?.patientNumber || order.patient?.externalId || order.patient?.nationalId || order.patient?.id || '-';
  const referredBy = order.patient?.address || order.notes || 'Himself';

  const dir = getDirection(order, orderTests, input.comments);

  // Logo: lab logo (base64 or URL) or fallback to default logo (e.g. backend/src/reports/logo.png)
  const labAny: any = order.lab as any;
  const logoSrc: string =
    (labAny?.logoBase64 as string) || (labAny?.logoUrl as string) || (input.defaultLogoBase64 ?? '');
  const visitDate = formatDateTime(order.registeredAt);
  const ageSex = `${age != null ? `${age} Years` : '-'}/${sexLabel}`;
  const logoUrlAttr = logoSrc ? `src="${escapeHtml(logoSrc)}"` : '';
  const templateLogo =
    'data:image/png;base64,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أ¢â‚¬آ¦48787 tokens truncatedأ¢â‚¬آ¦';

  // Doctors row (4 columns like your sample)
  const doctors = normalizeDoctors(order);

  // Flatten panels + children (your original behavior)
  const childrenByParent = new Map<string, OrderTest[]>();
  for (const ot of orderTests) {
    if (ot.parentOrderTestId) {
      const arr = childrenByParent.get(ot.parentOrderTestId) ?? [];
      arr.push(ot);
      childrenByParent.set(ot.parentOrderTestId, arr);
    }
  }

  const sortKey = (ot: OrderTest) => {
    const anyTest: any = ot.test;
    const sortOrder = anyTest?.sortOrder ?? 0;
    const code = (anyTest?.code || '').toUpperCase();
    return `${String(sortOrder).padStart(6, '0')}_${code}`;
  };
  for (const [, arr] of childrenByParent) arr.sort((a, b) => sortKey(a).localeCompare(sortKey(b)));

  const flattenedTests: OrderTest[] = [];
  const addWithChildren = (ot: OrderTest) => {
    flattenedTests.push(ot);
    const kids = childrenByParent.get(ot.id) || [];
    kids.forEach((child) => flattenedTests.push(child));
  };

  orderTests
    .filter((ot) => !ot.parentOrderTestId)
    .sort((a, b) => sortKey(a).localeCompare(sortKey(b)))
    .forEach((ot) => {
      if (ot.test?.type === TestType.PANEL) addWithChildren(ot);
      else flattenedTests.push(ot);
    });

  const reportReady = input.reportableCount > 0 && input.verifiedCount === input.reportableCount;
  const preliminary = input.reportableCount > 0 && !reportReady;
  const commentsText = input.comments.length ? input.comments.join(' أ¢â‚¬آ¢ ') : '';
  const verifierText = input.verifiers.join(', ') || (input.verifiedCount > 0 ? 'Verifier' : 'Pending');

  // Build results rows with department & category groupings (Word template style)
  let lastDept = '';
  let lastCat = '';
  const rowsHtml = flattenedTests
    .map((ot) => {
      const t: any = ot.test;
      const dept = getDeptName(t) || 'General Department';
      const cat = getCategoryName(t) || '';
      const flag = normalizeFlag(ot.flag as any);
      const statusText = flagToStatus(flag);
      const abnormal = isAbnormalFlag(flag);
      const params = formatParams(ot.resultParameters);
      const extra =
        params.length
          ? `<div class="extra-params">${params
              .slice(0, 4)
              .map((p) => escapeHtml(p))
              .join(' آ· ')}${params.length > 4 ? ' â€¦' : ''}</div>`
          : '';

      const deptRow =
        dept !== lastDept
          ? (() => {
              lastDept = dept;
              lastCat = '';
              return `<tr class="dept-row"><td colspan="5">${escapeHtml(dept)}</td></tr>`;
            })()
          : '';

      const catRow =
        cat && cat !== lastCat
          ? (() => {
              lastCat = cat;
              return `<tr class="cat-row"><td colspan="5">${escapeHtml(cat)}</td></tr><tr class="header-row"><th>Test </th><th>Result</th><th>Unit</th><th>Status</th><th>Reference Value</th></tr>`;
            })()
          : '';

      const headerFallback =
        !cat && deptRow
          ? `<tr class="header-row"><th>Test </th><th>Result</th><th>Unit</th><th>Status</th><th>Reference Value</th></tr>`
          : '';

      const row = `
        <tr class="result-row ${abnormal ? 'abnormal' : ''}">
          <td class="c-test">${escapeHtml(t?.name || '-')}${t?.code ? ` (${escapeHtml(t.code)})` : ''}</td>
          <td class="c-result">${escapeHtml(formatResultValue(ot))}${extra}</td>
          <td class="c-unit">${escapeHtml(t?.unit || '-')}</td>
          <td class="c-status">${escapeHtml(statusText)}</td>
          <td class="c-range">${escapeHtml(formatRange(ot, order.patient?.sex ?? null))}</td>
        </tr>
        <tr class="dotted-row"><td colspan="5"></td></tr>
      `;

      return deptRow + (catRow || headerFallback) + row;
    })
    .join('');

  // Reusable header + patient block for every page
  const pageHeaderHtml = `
    <header class="header">
      <div class="header-col ltr">
        <div>Kurdistan Regional Government - Iraq</div>
        <div>Ministry of Health</div>
        <div>General Directorate of Health Garmian</div>
      </div>
      <div class="logo-wrap">
        ${logoUrlAttr ? `<img class="logo" ${logoUrlAttr} alt="Logo" />` : '<div class="logo"></div>'}
      </div>
      <div class="header-col rtl">
        <div>حکومەتی هەرێمی کوردستان - عێراق</div>
        <div>وەزارەتی تەندروستی</div>
        <div>بەڕێوەبەرایەتی گشتی تەندروستی گەرمیان</div>
      </div>
    </header>
    <div class="patient-info">
      <div class="info-item"><span class="label">Name :</span>${escapeHtml(patientName)}</div>
      <div class="info-item"><span class="label">Visit Date:</span>${escapeHtml(visitDate)}</div>
      <div class="info-item"><span class="label">Patient ID:</span>${escapeHtml(patientId)}</div>
      <div class="info-item"><span class="label">Age/Sex:</span>${escapeHtml(ageSex)}</div>
    </div>
    <div class="report-title">Laboratory Report</div>
  `;

  // Panel tests: any PANEL (not just GUE/GSE) - will be added to main content below regular tests
  const isPanelParent = (ot: OrderTest) =>
    !ot.parentOrderTestId && (ot.test as any)?.type === TestType.PANEL;
  const panelTests = flattenedTests.filter(isPanelParent);
  const regularTests = flattenedTests.filter(
    (ot) => ot.parentOrderTestId || (ot.test as any)?.type !== TestType.PANEL
  );

  // Build panel content HTML to add to main content
  let panelContentHtml = '';
  for (let i = 0; i < panelTests.length; i++) {
    const ot = panelTests[i];
    const t: any = ot.test;
    const testName = t?.name || t?.code || 'Examination';
    const kids = childrenByParent.get(ot.id) || [];
    const params = Array.isArray(t?.parameterDefinitions) ? t.parameterDefinitions : [];
    const resultParams = ot.resultParameters && typeof ot.resultParameters === 'object' ? ot.resultParameters : {};

    let contentHtml = '';
    if (params.length > 0 || Object.keys(resultParams).length > 0) {
      let paramRows = params
        .map((p: { code?: string; label?: string; normalOptions?: string[] }) => {
          const val = p?.code ? resultParams[p.code] : '';
          const valStr = val != null ? String(val).trim() : '';
          const normalOpts = Array.isArray(p?.normalOptions) ? p.normalOptions : [];
          const isAbnormalParam = normalOpts.length > 0 && valStr !== '' && !normalOpts.includes(valStr);
          const valueCell = escapeHtml(valStr || '-');
          const referenceValue = normalOpts.length > 0 ? normalOpts.join(', ') : '-';
          let statusText = '-';
          let statusClass = '';
          if (valStr !== '') {
            if (normalOpts.length > 0) {
              if (isAbnormalParam) {
                statusText = 'Abnormal';
                statusClass = 'status-high';
              } else {
                statusText = 'Normal';
                statusClass = 'status-normal';
              }
            } else {
              statusText = '-';
            }
          }
          const rowClass = isAbnormalParam ? ' class="abnormal"' : '';
          return `<tr${rowClass}>
            <td style="width:28%;font-weight:600;">${escapeHtml(p?.label || p?.code || '')}</td>
            <td style="width:24%;">${valueCell}</td>
            <td style="width:24%;" class="${statusClass}">${escapeHtml(statusText)}</td>
            <td style="width:24%;">${escapeHtml(referenceValue)}</td>
          </tr>`;
        })
        .join('');
      if (!paramRows && Object.keys(resultParams).length > 0) {
        paramRows = Object.entries(resultParams)
          .filter(([, v]) => v != null && String(v).trim() !== '')
          .map(([k, v]) => `<tr>
            <td style="width:28%;font-weight:600;">${escapeHtml(k)}</td>
            <td style="width:24%;">${escapeHtml(String(v))}</td>
            <td style="width:24%;">-</td>
            <td style="width:24%;">-</td>
          </tr>`)
          .join('');
      }
      contentHtml = `<table class="gue-gse-table">
        <thead><tr><th style="width:28%;">Test</th><th style="width:24%;">Result</th><th style="width:24%;">Status</th><th style="width:24%;">Reference Value</th></tr></thead>
        <tbody>${paramRows || '<tr><td colspan="4">No parameters</td></tr>'}</tbody>
      </table>`;
    } else if (kids.length > 0) {
      const childRows = kids
        .map((child) => {
          const ct: any = child.test;
          const flag = normalizeFlag(child.flag as any);
          const statusText = flagToStatus(flag);
          const abnormal = isAbnormalFlag(flag);
          const statusClass = abnormal ? (flag.startsWith('H') ? 'status-high' : 'status-low') : 'status-normal';
          return `<tr class="${abnormal ? 'abnormal' : ''}">
            <td style="width:28%;">${escapeHtml(ct?.name || '-')}</td>
            <td style="width:14%;" class="nowrap">${escapeHtml(formatResultValue(child))}</td>
            <td style="width:14%;" class="nowrap">${escapeHtml(ct?.unit || '-')}</td>
            <td style="width:14%;" class="${statusClass}">${escapeHtml(statusText)}</td>
            <td style="width:30%;" class="nowrap">${escapeHtml(formatRange(child, order.patient?.sex ?? null))}</td>
          </tr>`;
        })
        .join('');
      contentHtml = `<table>
        <thead><tr><th style="width:28%;">Test</th><th style="width:14%;">Result</th><th style="width:14%;">Unit</th><th style="width:14%;">Status</th><th style="width:30%;">Reference Value</th></tr></thead>
        <tbody>${childRows}</tbody>
      </table>`;
    } else {
      contentHtml = '<table class="gue-gse-table"><tbody><tr><td colspan="2">No data</td></tr></tbody></table>';
    }
    panelContentHtml += `
      <div class="panel-section" style="margin-top: 20px;">
        <div class="panel-page-title">${escapeHtml(testName)}</div>
        ${contentHtml}
      </div>`;
  }

  // Group regular tests by department then category
  const deptCatMap = new Map<string, Map<string, OrderTest[]>>();
  for (const ot of regularTests) {
    const t: any = ot.test;
    const dept = getDeptName(t) || 'General Department';
    const cat = getCategoryName(t) || '';
    if (!deptCatMap.has(dept)) deptCatMap.set(dept, new Map());
    const catMap = deptCatMap.get(dept)!;
    if (!catMap.has(cat)) catMap.set(cat, []);
    catMap.get(cat)!.push(ot);
  }
  let sectionsHtml = '';
  for (const [dept, catMap] of deptCatMap) {
    sectionsHtml += `<div class="dept-title ltr">${escapeHtml(dept)}</div>`;
    for (const [cat, tests] of catMap) {
      if (cat) sectionsHtml += `<div class="test-group-title ltr">${escapeHtml(cat)}</div>`;
      const tableRows = tests
        .map((ot) => {
          const t: any = ot.test;
          const flag = normalizeFlag(ot.flag as any);
          const statusText = flagToStatus(flag);
          const abnormal = isAbnormalFlag(flag);
          const statusClass = abnormal ? (flag.startsWith('H') ? 'status-high' : 'status-low') : 'status-normal';
          return `<tr class="${abnormal ? 'abnormal' : ''}">
          <td style="width:28%;">${escapeHtml(t?.name || '-')}</td>
          <td style="width:14%;" class="nowrap">${escapeHtml(formatResultValue(ot))}</td>
          <td style="width:14%;" class="nowrap">${escapeHtml(t?.unit || '-')}</td>
          <td style="width:14%;" class="${statusClass}">${escapeHtml(statusText)}</td>
          <td style="width:30%;" class="nowrap">${escapeHtml(formatRange(ot, order.patient?.sex ?? null))}</td>
        </tr>`;
        })
        .join('');
      sectionsHtml += `<table>
      <thead><tr><th style="width:28%;">Test</th><th style="width:14%;">Result</th><th style="width:14%;">Unit</th><th style="width:14%;">Status</th><th style="width:30%;">Reference Value</th></tr></thead>
      <tbody>${tableRows}</tbody>
    </table>`;
    }
  }
  if (!sectionsHtml && regularTests.length === 0 && panelTests.length === 0) {
    sectionsHtml = '<div class="dept-title ltr">No tests</div>';
  }

  // Build pages: regular tests on first page, panel tests on second page (if exists)
  let pagesHtml = '';
  
  // Page 1: Regular tests
  if (regularTests.length > 0) {
    pagesHtml += `
    <div class="page">
      ${pageHeaderHtml}
      <div class="content">
        ${sectionsHtml}
        ${commentsText && panelTests.length === 0 ? `<div class="comments" style="margin-top:8px;font-size:11px;font-weight:700;"><strong>Comments:</strong> ${escapeHtml(commentsText)}</div>` : ''}
      </div>
    </div>`;
  }
  
  // Page 2: Panel tests (if any)
  if (panelContentHtml) {
    pagesHtml += `
    <div class="page" style="page-break-before: ${regularTests.length > 0 ? 'always' : 'auto'};">
      ${pageHeaderHtml}
      <div class="content">
        ${panelContentHtml}
        ${commentsText ? `<div class="comments" style="margin-top:8px;font-size:11px;font-weight:700;"><strong>Comments:</strong> ${escapeHtml(commentsText)}</div>` : ''}
      </div>
    </div>`;
  }
  
  // If no tests at all
  if (regularTests.length === 0 && panelTests.length === 0) {
    pagesHtml += `
    <div class="page">
      ${pageHeaderHtml}
      <div class="content">
        ${sectionsHtml}
      </div>
    </div>`;
  }

  return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laboratory Report</title>
  <style>
    @page { size: A4; margin: 7mm 7mm 7mm 7mm; }
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Arial, sans-serif; font-size: 12px; color: #333; position: relative; }
    .rtl { direction: rtl; unicode-bidi: isolate; }
    .ltr { direction: ltr; unicode-bidi: isolate; }
    .nowrap { white-space: nowrap; }
    .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); opacity: 0.06; width: 420px; z-index: 0; pointer-events: none; }
    .page { position: relative; z-index: 1; padding: 5mm 0 20mm 0; page-break-inside: avoid; }
    .header { display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #222; padding: 0 16mm 12px 16mm; }
    .header-col { flex: 1; font-size: 13px; font-weight: 700; line-height: 1.35; }
    .header-col.ltr { text-align: left; }
    .header-col.rtl {
      text-align: right;
      font-family: 'Noto Naskh Arabic', 'Noto Sans Arabic', 'Segoe UI', Tahoma, Arial, sans-serif;
    }
    .logo-wrap { flex: 0 0 120px; text-align: center; }
    .logo { width: 90px; height: auto; object-fit: contain; }
    .report-title { text-align: center; font-size: 20px; font-weight: 800; text-decoration: underline; margin: 16px 0 14px; }
    .patient-info { margin: 16px 16mm 16px 16mm; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border: 1px solid #ccc; border-radius: 6px; padding: 12px 14px; background: #fafafa; }
    .info-item { font-size: 13px; }
    .info-item .label { font-weight: 700; margin-right: 4px; }
    .content { padding: 0 16mm; }
    .dept-title { background: #222; color: #fff; padding: 8px 12px; font-weight: 800; margin-top: 18px; }
    .test-group-title { background: #f2f2f2; color: #555; padding: 6px 12px; font-weight: 700; border: 1px solid #ddd; border-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
    th, td { border: 1px solid #eee; padding: 6px 8px; text-align: left; font-size: 12px; }
    th { background: #f2f2f2; font-weight: 700; }
    .status-low { color: #0066cc; font-weight: 700; }
    .status-high { color: #d00000; font-weight: 700; }
    .status-normal { color: #0f8a1f; }
    .param-abnormal { color: #c00; font-size: 11px; font-weight: 600; margin-left: 4px; }
    tr.abnormal td { background-color: #fff5f5; }
    .panel-section { margin-top: 20px; }
    .panel-page-title { font-size: 18px; font-weight: 800; margin-bottom: 12px; border-bottom: 2px solid #222; padding-bottom: 6px; }
    .panel-page .content { padding: 0 16mm; }
    .gue-gse-table { width: 100%; margin-top: 8px; margin-bottom: 12px; }
    .footer { margin: 28px 16mm 0 16mm; text-align: center; font-size: 11px; border-top: 1px solid #eee; padding-top: 10px; color: #888; }
    * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  </style>
</head>
<body>
  ${logoUrlAttr ? `<img ${logoUrlAttr} class="watermark" alt="Watermark" />` : ''}
  ${pagesHtml}
</body>
</html>
  `;
}
